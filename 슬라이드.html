<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>슬라이드</title>
    <link rel="stylesheet" href="styles/carousel-slider.css">
    <link rel="stylesheet" href="styles/slide.css">
</head>
<body>
    <div class="app-container">
        <!-- 로딩 화면 -->
        <div class="loading-screen hidden" id="loadingScreen">
            <div class="loading-spinner"></div>
            <div class="loading-text">슬라이드 생성 중...</div>
            <div class="loading-subtitle">설정을 불러오고 이미지를 준비하고 있습니다</div>
        </div>
        
        <!-- 오류 화면 -->
        <div class="error-screen hidden" id="errorScreen">
            <div class="error-icon">⚠️</div>
            <div class="error-title">오류가 발생했습니다</div>
            <div class="error-message" id="errorMessage">
                문제가 발생했습니다.<br><br>
                <strong>해결 방법:</strong><br>
                1. <button class="error-btn inline" onclick="selectConfigFile()">config.json 파일 선택</button> (File System API 사용)<br>
                2. 또는 작업 폴더에 슬라이드.html을 복사해서 실행<br><br>
                <strong>올바른 사용법:</strong><br>
                1. 관리 도구에서 작업 폴더를 선택하고 이미지를 추가하세요<br>
                2. 선택한 작업 폴더에 슬라이드.html 파일을 복사하세요<br>
                3. 작업 폴더의 슬라이드.html을 실행하세요<br><br>
                <small>이미지는 상대 경로(images/)로 참조되므로 같은 폴더에서 실행해야 합니다.</small>
            </div>
            <div class="error-actions">
                <button class="error-btn" onclick="retryLoad()">다시 시도</button>
                <button class="error-btn secondary" onclick="openAdmin()">관리 도구 열기</button>
            </div>
        </div>
        
        <!-- 브라우저 비지원 오버레이 -->
        <div class="browser-unsupported-overlay hidden" id="browserUnsupportedOverlay">
            <div class="unsupported-content">
                <div class="unsupported-icon">🌐</div>
                <div class="unsupported-title">브라우저가 지원되지 않습니다</div>
                <div class="unsupported-message">
                    이 슬라이드 애플리케이션은 <strong>File System Access API</strong>를 사용합니다.<br>
                    현재 브라우저에서는 이 기능이 지원되지 않습니다.
                </div>
                <div class="recommended-browsers">
                    <div class="browsers-title">권장 브라우저:</div>
                    <div class="browser-list">
                        <div class="browser-item">
                            <span class="browser-icon">🟢</span>
                            <span class="browser-name">Google Chrome</span>
                        </div>
                    </div>
                </div>
                <div class="unsupported-note">
                    <strong>참고:</strong> 권장 브라우저를 사용하여 다시 시도해주세요.
                </div>
                <div class="unsupported-actions">
                    <button class="error-btn" onclick="window.location.reload()">새로고침</button>
                    <button class="error-btn secondary" onclick="window.close()">닫기</button>
                </div>
            </div>
        </div>
        
        <!-- 헤더 정보 -->
        <div class="header-info" id="headerInfo">
            <span id="imageCounter">0/0</span> • 
            <span id="playStatus">일시정지됨</span>
        </div>
        
        <!-- 슬라이드 컨테이너 -->
        <div class="carousel-container" id="carouselContainer"></div>
        
        <!-- 키보드 도움말 -->
        <div class="keyboard-help" id="keyboardHelp">
            <div class="help-title">키보드 컨트롤</div>
            <div class="help-item"><span class="help-key">←</span> 이전 이미지</div>
            <div class="help-item"><span class="help-key">→</span> 다음 이미지</div>
            <div class="help-item"><span class="help-key">Space</span> 재생/일시정지</div>
            <div class="help-item"><span class="help-key">?</span> 도움말 표시/숨김</div>
        </div>
    </div>

    <script src="config-manager.js"></script>
    <script src="carousel-slider.js"></script>
    <script>
        class SlideApp {
            constructor() {
                this.configManager = null;
                this.carousel = null;
                this.retryCount = 0;
                this.maxRetries = 3;
                
                this.init();
            }

            async init() {
                // 브라우저 지원 여부 먼저 체크
                if (!this.checkBrowserSupport()) {
                    return; // 지원되지 않으면 초기화 중단
                }
                
                try {
                    this.showLoading('설정 관리자 초기화 중...');

                    // ConfigManager 초기화
                    this.configManager = new ConfigManager();

                    // 설정 로드 대기
                    await this.waitForConfig();

                    this.showLoading('슬라이드 생성 중...');

                    // 슬라이드 초기화
                    const container = document.getElementById('carouselContainer');
                    this.carousel = new CarouselSlider(container, this.configManager);

                    // 이벤트 리스너 설정
                    this.setupEventListeners();

                    // UI 업데이트
                    this.updateHeaderInfo();

                    // 정상적으로 슬라이드이 생성되면 모든 에러/로딩 화면 숨김
                    setTimeout(() => {
                        this.hideLoading();
                        this.hideError();
                        // 키보드 가이드 자동 표시 제거
                    }, 1000);

                } catch (error) {
                    console.error('앱 초기화 실패:', error);
                    
                    // 이미 오류 화면이 표시된 경우 추가 처리하지 않음
                    if (error.message === '이미지가 없습니다') {
                        return;
                    }
                    
                    this.showError('초기화 중 오류가 발생했습니다.', error.message);
                }
            }

            checkBrowserSupport() {
                const isSupported = 'showOpenFilePicker' in window && 'showDirectoryPicker' in window;
                
                if (!isSupported) {
                    console.warn('❌ File System Access API가 지원되지 않는 브라우저입니다');
                    this.showBrowserUnsupportedOverlay();
                    return false;
                }
                
                console.log('✅ File System Access API 지원 브라우저입니다');
                return true;
            }

            showBrowserUnsupportedOverlay() {
                const overlay = document.getElementById('browserUnsupportedOverlay');
                overlay.classList.remove('hidden');
            }

            async waitForConfig() {
                return new Promise((resolve, reject) => {
                    const checkConfig = () => {
                        const config = this.configManager.getConfig();
                        if (config) {
                            // 작업 폴더 정보 표시
                            if (config.workspaceInfo) {
                                console.log("📁 작업 폴더 정보:", config.workspaceInfo);
                                console.log(`현재 실행 위치: ${window.location.href}`);
                                console.log(`예상 이미지 경로: ${window.location.origin}${window.location.pathname.replace(/[^/]*$/, '')}images/`);
                            }
                            
                            const images = this.configManager.getActiveImages();
                            if (images.length === 0) {
                                // 이미지가 없을 때는 오류 화면 표시
                                console.log('⚠️ 표시할 이미지가 없습니다.');
                                
                                // 작업 폴더 정보가 있는지 확인
                                if (config.workspaceInfo) {
                                    // config.json은 로드되었지만 이미지가 없는 경우
                                    this.showError(
                                        '이미지가 없습니다',
                                        `config.json은 로드되었지만 표시할 이미지가 없습니다.<br><br>` +
                                        `관리 도구에서 이미지를 추가하거나,<br>` +
                                        `다른 config.json 파일을 선택해 주세요.`
                                    );
                                } else {
                                    // 기본 설정으로 시작된 경우 (config.json 로드 실패)
                                    this.showError(
                                        'config.json을 찾을 수 없습니다',
                                        `config.json 파일을 로드할 수 없습니다.<br><br>` +
                                        `<strong>해결 방법:</strong><br>` +
                                        `1. 아래 버튼으로 config.json 파일을 직접 선택<br>` +
                                        `2. 관리 도구에서 생성된 images 폴더의 config.json 선택<br>` +
                                        `3. 또는 작업 폴더에 슬라이드.html을 복사해서 실행<br><br>` +
                                        `<small>💡 관리 도구를 먼저 실행하면 config.json이 자동으로 생성됩니다.</small>`
                                    );
                                }
                                reject(new Error('이미지가 없습니다'));
                                return;
                            } else {
                                console.log(`📷 로드할 활성 이미지: ${images.length}개`);
                                resolve();
                            }
                        } else {
                            setTimeout(checkConfig, 100);
                        }
                    };
                    
                    checkConfig();
                    
                    // 10초 타임아웃으로 연장 (이미지 스캔 시간 고려)
                    setTimeout(() => {
                        reject(new Error('설정 로드 시간 초과'));
                    }, 10000);
                });
            }

            setupEventListeners() {
                // 설정 변경 감지
                this.configManager.addEventListener('configChanged', () => {
                    this.updateHeaderInfo();
                    if (this.carousel) {
                        this.carousel.updateFromConfig();
                    }
                    // 키보드 가이드 상태 업데이트
                    this.updateKeyboardHelpVisibility();
                });

                // config.json 파일 자동 리로드 감지
                this.configManager.addEventListener('configReloaded', () => {
                    console.log('🔄 config.json 자동 리로드 감지 - 슬라이드 업데이트 중...');
                    this.handleConfigReload();
                });

                // 슬라이드 슬라이드 변경 감지
                const carouselContainer = document.getElementById('carouselContainer');
                carouselContainer.addEventListener('slideChanged', (event) => {
                    this.updateHeaderInfo();
                });

                // 키보드 도움말 토글
                document.addEventListener('keydown', (e) => {
                    if (e.key === '?' || e.key === 'h' || e.key === 'H') {
                        e.preventDefault();
                        this.toggleKeyboardHelp();
                    }
                    
                    // 키보드 컨트롤 사용 (자동 도움말 표시 제거)
                    // 키보드 가이드는 관리 도구에서 확인 가능
                });

                // 슬라이드 상태 변경 감지
                const playPauseBtn = document.querySelector('.carousel-play-pause');
                if (playPauseBtn) {
                    const observer = new MutationObserver(() => {
                        this.updatePlayStatus();
                    });
                    observer.observe(playPauseBtn, { childList: true, characterData: true, subtree: true });
                }

                // 윈도우 포커스/블러 이벤트
                window.addEventListener('focus', () => {
                    if (this.carousel && this.carousel.isPlaying) {
                        this.updatePlayStatus();
                    }
                });

                // 페이지 가시성 변경
                document.addEventListener('visibilitychange', () => {
                    this.updatePlayStatus();
                });
            }

            updateHeaderInfo() {
                const images = this.configManager.getActiveImages();
                const currentIndex = this.carousel ? this.carousel.currentIndex : 0;
                
                // console.log('📊 updateHeaderInfo 호출:', {
                //     currentIndex: currentIndex,
                //     totalImages: images.length,
                //     displayText: `${currentIndex + 1}/${images.length}`
                // });
                
                document.getElementById('imageCounter').textContent = 
                    `${currentIndex + 1}/${images.length}`;
                
                this.updatePlayStatus();
            }

            updatePlayStatus() {
                const isPlaying = this.carousel && this.carousel.isPlaying;
                const statusElement = document.getElementById('playStatus');
                
                if (document.hidden) {
                    statusElement.textContent = '백그라운드';
                } else if (isPlaying) {
                    statusElement.textContent = '재생 중';
                } else {
                    statusElement.textContent = '일시정지됨';
                }
            }

            showLoading(message) {
                const loadingScreen = document.getElementById('loadingScreen');
                const loadingText = loadingScreen.querySelector('.loading-text');
                
                loadingText.textContent = message;
                loadingScreen.classList.remove('hidden');
            }

            hideLoading() {
                document.getElementById('loadingScreen').classList.add('hidden');
            }

            showError(title, message) {
                const errorScreen = document.getElementById('errorScreen');
                const errorTitle = errorScreen.querySelector('.error-title');
                const errorMessage = document.getElementById('errorMessage');

                errorTitle.textContent = title;
                errorMessage.innerHTML = message;

                this.hideLoading();
                errorScreen.classList.remove('hidden');
            }

            hideError() {
                document.getElementById('errorScreen').classList.add('hidden');
            }

            updateKeyboardHelpVisibility() {
                const helpElement = document.getElementById('keyboardHelp');
                const settings = this.configManager.getSettings();
                
                if (settings.showControls === false) {
                    helpElement.classList.add('controls-hidden');
                    helpElement.classList.remove('show');
                } else {
                    helpElement.classList.remove('controls-hidden');
                }
            }

            showKeyboardHelp() {
                const helpElement = document.getElementById('keyboardHelp');
                const settings = this.configManager.getSettings();
                
                // 컨트롤이 표시되는 경우에만 키보드 가이드 표시
                if (settings.showControls !== false) {
                    helpElement.classList.add('show');
                    helpElement.classList.remove('controls-hidden');
                } else {
                    helpElement.classList.add('controls-hidden');
                    helpElement.classList.remove('show');
                }
                
                // 자동 숨김 기능 제거 - 사용자가 직접 토글해야 함
                // 가이드는 관리 도구에서 확인 가능
            }

            toggleKeyboardHelp() {
                const helpElement = document.getElementById('keyboardHelp');
                const settings = this.configManager.getSettings();
                
                // 컨트롤이 표시되는 경우에만 토글 가능
                if (settings.showControls !== false) {
                    helpElement.classList.toggle('show');
                    helpElement.classList.remove('controls-hidden');
                } else {
                    helpElement.classList.add('controls-hidden');
                    helpElement.classList.remove('show');
                }
            }

            // config.json 자동 리로드 처리
            async handleConfigReload() {
                try {
                    console.log('🔄 슬라이드 화면 config 리로드 처리');
                    
                    // 헤더 정보 업데이트
                    this.updateHeaderInfo();
                    
                    // 캐러셀 업데이트
                    if (this.carousel) {
                        this.carousel.updateFromConfig();
                    }
                    
                    // 키보드 도움말 표시 상태 업데이트
                    this.updateKeyboardHelpVisibility();
                    
                } catch (error) {
                    console.error('슬라이드 config 리로드 중 오류:', error);
                }
            }

            async retry() {
                if (this.retryCount >= this.maxRetries) {
                    this.showError(
                        '재시도 한계 초과', 
                        '계속해서 문제가 발생합니다.<br>관리 도구에서 설정을 확인해 주세요.'
                    );
                    return;
                }

                this.retryCount++;
                this.hideError();
                
                // 기존 인스턴스 정리
                if (this.carousel) {
                    this.carousel.destroy();
                }

                // 다시 초기화
                await this.init();
            }

            openAdminTool() {
                // 관리 도구 새 창으로 열기
                const adminUrl = './슬라이드관리도구.html';
                window.open(adminUrl, '_blank', 'width=600,height=800');
            }
        }

        // 전역 함수들 (HTML에서 호출됨)
        let app;

        function retryLoad() {
            if (app) {
                app.retry();
            }
        }

        function openAdmin() {
            if (app) {
                app.openAdminTool();
            }
        }

        function selectConfigFile() {
            if (app && app.configManager) {
                // 로딩 화면 표시
                app.showLoading('config.json 파일을 선택해 주세요...');
                
                // ConfigManager의 loadConfigFromFile을 강제로 실행하여 파일 선택 유도
                app.configManager.loadConfigFromFile().then(success => {
                    if (success) {
                        app.showLoading('설정이 로드되었습니다. 슬라이드를 다시 시작합니다...');
                        // 성공 시 앱 재시작
                        setTimeout(() => {
                            app.retry();
                        }, 1000);
                    } else {
                        app.hideLoading();
                        console.log("config.json 파일 선택이 취소되었거나 실패했습니다.");
                    }
                }).catch(error => {
                    app.hideLoading();
                    console.error("config.json 파일 로드 중 오류:", error);
                });
            }
        }

        // 앱 시작
        document.addEventListener('DOMContentLoaded', () => {
            app = new SlideApp();
        });

        // 페이지 종료 시 메모리 정리
        window.addEventListener('beforeunload', () => {
            if (app) {
                if (app.carousel) {
                    app.carousel.destroy();
                }
                if (app.configManager) {
                    app.configManager.destroy();
                }
            }
        });

        // 에러 핸들링
        window.addEventListener('error', (event) => {
            console.error('전역 오류:', event.error);
            if (app) {
                app.showError(
                    '예상치 못한 오류',
                    '페이지에서 오류가 발생했습니다.<br>새로고침을 시도해 주세요.'
                );
            }
        });

        // 프라미스 에러 핸들링
        window.addEventListener('unhandledrejection', (event) => {
            console.error('처리되지 않은 프라미스 거부:', event.reason);
        });
    </script>
</body>
</html>